name: Deploy Prep

on:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

concurrency:
  group: deploy-prep-${{ github.ref }}
  cancel-in-progress: true

jobs:
  safety-gate:
    runs-on: ubuntu-latest
    outputs:
      main_sha: ${{ steps.guard.outputs.main_sha }}
    steps:
      - name: Verify latest main commit has passing CI
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";

            const branchRes = await github.rest.repos.getBranch({ owner, repo, branch });
            const mainSha = branchRes.data.commit.sha;
            core.info(`Latest main SHA: ${mainSha}`);
            core.setOutput("main_sha", mainSha);

            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner,
              repo,
              head_sha: mainSha,
              per_page: 100
            });

            const ciRuns = runs.filter((r) => r.name === "CI");
            if (ciRuns.length === 0) {
              core.setFailed(`No CI runs found for main SHA ${mainSha}.`);
              return;
            }

            ciRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const latest = ciRuns[0];
            core.info(`Latest CI run: #${latest.run_number} status=${latest.status} conclusion=${latest.conclusion}`);

            if (latest.status !== "completed" || latest.conclusion !== "success") {
              core.setFailed(`Latest main commit does not have successful CI. Run URL: ${latest.html_url}`);
              return;
            }

  deploy-placeholder:
    needs: safety-gate
    runs-on: ubuntu-latest
    steps:
      - name: CD prep passed
        run: |
          echo "Safety gate passed for main SHA: ${{ needs.safety-gate.outputs.main_sha }}"
          echo "Next step: replace this placeholder with actual deploy commands."

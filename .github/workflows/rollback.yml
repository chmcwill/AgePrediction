name: CD Rollback

on:
  workflow_dispatch:
    inputs:
      image_uri_digest:
        description: "ECR image URI digest to roll back to (example: 123456789012.dkr.ecr.us-east-2.amazonaws.com/repo@sha256:...)"
        required: false
        type: string
      use_last_good:
        description: "Use SSM last-known-good image digest"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-rollback-${{ github.ref }}
  cancel-in-progress: false

env:
  SSM_LAST_GOOD_IMAGE_PARAM: ${{ vars.SSM_LAST_GOOD_IMAGE_PARAM || '/agepred/prod/last_good_image_digest' }}

jobs:
  rollback:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load deploy config
        id: load-config
        run: |
          python3 scripts/load_deploy_config.py --emit deploy-outputs >> "$GITHUB_OUTPUT"
          python3 scripts/load_deploy_config.py --emit aws-region-env >> "$GITHUB_ENV"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_CD_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve rollback image digest
        env:
          INPUT_IMAGE_URI_DIGEST: ${{ inputs.image_uri_digest }}
          USE_LAST_GOOD: ${{ inputs.use_last_good }}
        run: |
          if [ "$USE_LAST_GOOD" = "true" ]; then
            IMAGE_URI_DIGEST=$(aws ssm get-parameter \
              --name "${SSM_LAST_GOOD_IMAGE_PARAM}" \
              --query "Parameter.Value" \
              --output text)
            if [ -z "$IMAGE_URI_DIGEST" ] || [ "$IMAGE_URI_DIGEST" = "None" ]; then
              echo "::error ::No SSM last-known-good image found at ${SSM_LAST_GOOD_IMAGE_PARAM}."
              exit 1
            fi
          else
            IMAGE_URI_DIGEST="$INPUT_IMAGE_URI_DIGEST"
          fi
          if [[ -z "$IMAGE_URI_DIGEST" || "$IMAGE_URI_DIGEST" != *"@sha256:"* ]]; then
            echo "::error ::Rollback image must be in digest format (repo@sha256:...)."
            exit 1
          fi
          echo "IMAGE_URI_DIGEST=$IMAGE_URI_DIGEST" >> "$GITHUB_ENV"

      - name: Deploy rollback image to CloudFormation
        run: |
          PARAMS=(
            "ImageUri=${IMAGE_URI_DIGEST}"
            "BucketPrefix=${{ steps.load-config.outputs.bucket_prefix }}"
            "FunctionMemorySize=${{ steps.load-config.outputs.function_memory_size }}"
            "FunctionTimeout=${{ steps.load-config.outputs.function_timeout }}"
            "PresignExpireSeconds=${{ steps.load-config.outputs.presign_expire_seconds }}"
            "ResultUrlExpireSeconds=${{ steps.load-config.outputs.result_url_expire_seconds }}"
            "ApiCustomDomainName=${{ steps.load-config.outputs.api_custom_domain_name }}"
          )
          if [ -n "${{ steps.load-config.outputs.api_custom_domain_cert_arn }}" ]; then
            PARAMS+=("ApiCustomDomainCertificateArn=${{ steps.load-config.outputs.api_custom_domain_cert_arn }}")
          else
            PARAMS+=("ApiCustomDomainCertificateArn=")
          fi

          aws cloudformation deploy \
            --template-file template.yaml \
            --stack-name "${{ steps.load-config.outputs.stack_name }}" \
            --capabilities CAPABILITY_IAM \
            --region "$AWS_REGION" \
            --parameter-overrides "${PARAMS[@]}"

      - name: Update frontend config and sync static files
        run: |
          BUILD_VERSION="rollback-$(date -u +'%Y-%m-%dT%H:%M:%SZ')-${GITHUB_SHA::7}"
          cat > static/config.json <<EOF
          {
            "apiBase": "",
            "buildVersion": "${BUILD_VERSION}"
          }
          EOF

          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "${{ steps.load-config.outputs.stack_name }}" \
            --region "$AWS_REGION" \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendBucketName'].OutputValue | [0]" \
            --output text)
          if [ -z "$FRONTEND_BUCKET" ] || [ "$FRONTEND_BUCKET" = "None" ]; then
            echo "::error ::Could not resolve FrontendBucketName from stack outputs."
            exit 1
          fi
          aws s3 sync static "s3://$FRONTEND_BUCKET" --delete

      - name: Invalidate CloudFront cache
        run: |
          DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name "${{ steps.load-config.outputs.stack_name }}" \
            --region "$AWS_REGION" \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue | [0]" \
            --output text)
          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "::error ::Could not resolve CloudFrontDistributionId from stack outputs."
            exit 1
          fi
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*"
